"use strict";function ownKeys(i,e){var t,o=Object.keys(i);return Object.getOwnPropertySymbols&&(t=Object.getOwnPropertySymbols(i),e&&(t=t.filter(function(e){return Object.getOwnPropertyDescriptor(i,e).enumerable})),o.push.apply(o,t)),o}function _objectSpread(i){for(var e=1;e<arguments.length;e++){var t=null!=arguments[e]?arguments[e]:{};e%2?ownKeys(t,!0).forEach(function(e){_defineProperty(i,e,t[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(i,Object.getOwnPropertyDescriptors(t)):ownKeys(t).forEach(function(e){Object.defineProperty(i,e,Object.getOwnPropertyDescriptor(t,e))})}return i}function _defineProperty(e,i,t){return i in e?Object.defineProperty(e,i,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[i]=t,e}function _classCallCheck(e,i){if(!(e instanceof i))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,i){for(var t=0;t<i.length;t++){var o=i[t];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}function _createClass(e,i,t){return i&&_defineProperties(e.prototype,i),t&&_defineProperties(e,t),e}var Player=function(){function r(e,i){_classCallCheck(this,r);var t=getConfig("roleConfig"),o=getConfig("tornadoConfig"),a=getConfig("fireConfig"),s=getConfig("knifeConfig"),n=getConfig("axConfig");this.config=_objectSpread({moveSpeed:200,scaleAnTime:400,bulletDis:500,bulletSpeed:700,tornadosRotationSpeed:.04,tornadosCount:6,petFireSpeed:500,petFireDis:100,petFireCount:5,petFireCreateDis:1e3,knifeCount:6,knifeCreateDis:300,knifeSpeed:500,roleScale:.7,tornadoScale:.3,fireScale:.2,knifeScale:.2,stickY:2.5,axRotateSpeed:.3,axTimeDis:500,axContinuedTime:3e3,axScale:.2},t,{},o,{},a,{},s,{},n),this.isDead=!1,this.maxLife=this.config.life,this.life=this.config.life,this.fireTime=(new Date).getTime(),this.petFireTime=(new Date).getTime(),this.petFireCreateTime=(new Date).getTime(),this.knifeCreateTime=(new Date).getTime(),this.axTime=(new Date).getTime(),this.axLastTime=(new Date).getTime(),this.isPetFire=!0,this.stopTornado=!0,this.stopKnife=!0,this.stopPetFire=!0,this.stopAx=!0,this.audioAxStop=!0,this.petFireCount=0,this.init(e,i)}return _createClass(r,[{key:"init",value:function(e,i){this.initPlayer(e,i),this.initVirtualJoystick()}},{key:"initPlayer",value:function(e,i){this.player=game.add.sprite(e,i,keyMap.player),game.physics.arcade.enable(this.player,Phaser.Physics.ARCADE),this.player.body.setSize(this.player.width,this.player.height),this.player.scale.set(this.config.roleScale,this.config.roleScale),this.player.body.immovable=!0,this.player.body.collideWorldBounds=!0,this.addPet(),this.pet.visible=!1,this.player.anchor.set(.5,.5);var t=game.add.tween(this.player).to({height:this.player.height/1.2,width:1.2*this.player.width},this.config.scaleAnTime,Phaser.Easing.Sinusoidal.Out,!0);t.yoyo(!0),t.repeat(),this.animations=this.player.animations,this.animations.add("left",[0],5,!0),this.animations.add("right",[1],5,!0),this.animations.frame=4,this.bullets=game.add.group(),this.bullets.enableBody=!0,this.blood=game.add.graphics(),this.player.addChild(this.blood),this.drawBlood(this.player.width),this.KnifeGroup=game.add.group(),this.KnifeGroup.enableBody=!0,this.audioKnife=game.add.audio(keyMap.audioKnife,1),this.audioFire=game.add.audio(keyMap.audioFire,1),this.audioAx=game.add.audio(keyMap.audioAx,1);var o=game.add.sprite(this.player.x,this.player.y,keyMap.ax);this.ax=o,game.physics.arcade.enableBody(this.ax),this.ax.visible=!1,this.ax.body.setSize(this.ax.width-rem2px(2),this.ax.height-rem2px(2)),o.anchor.set(.5,.5),o.scale.set(this.config.axScale,this.config.axScale),this.isDead=!1}},{key:"initVirtualJoystick",value:function(){this.pad=game.plugins.add(Phaser.VirtualJoystick),this.stick=this.pad.addStick(game.world.centerX,game.world.centerY+rem2px(this.config.stickY),200,keyMap.joystick),this.stick.scale=scaleAdaptation(rem2px(6))}},{key:"run",value:function(){this.stick.isDown?0<game.physics.arcade.velocityFromRotation(this.stick.rotation,this.stick.force*this.config.moveSpeed,this.player.body.velocity).x?(this.pet.frame=1,this.animations.play("right"),this.player.direction="right"):(this.pet.frame=0,this.animations.play("left"),this.player.direction="left"):this.stop()}},{key:"stop",value:function(){this.animations.stop(),this.player.body.velocity.set(0)}},{key:"start",value:function(){this.animations.play()}},{key:"fire",value:function(e){var i,t,o=this;this.isDead||(i=this.player.direction,(new Date).getTime()-this.fireTime>this.config.bulletDis&&((t=this.bullets.getFirstExists(!1))||((t=this.bullets.create(this.player.x,this.player.y,keyMap.gun)).scale.set(.5,.5),t.anchor.set(.5,.5),t.body.setSize(t.width,t.height)),t.reset(this.player.x,this.player.y),t.checkWorldBounds=!0,t.outOfBoundsKill=!0,t.vector=null,"right"===i?(t.direction="right",t.rotation=3.14):(t.rotation=0,t.direction="left"),e&&(t.vector=computeVector(e.position.x,e.position.y,t.position.x,t.position.y),t.rotation=computeRotation(e.position.x,e.position.y,t.position.x,t.position.y)+Math.PI),this.fireTime=(new Date).getTime()),this.bullets.length&&this.bullets.forEachAlive(function(e){e.vector?(e.body.velocity.x=e.vector.x*o.config.bulletSpeed,e.body.velocity.y=e.vector.y*o.config.bulletSpeed):"left"===e.direction?e.body.velocity.x=-o.config.bulletSpeed:e.body.velocity.x=o.config.bulletSpeed}))}},{key:"dead",value:function(){this.player.kill(),this.isDead=!0}},{key:"injury",value:function(){--this.life;var e=this.life/this.maxLife*this.player.width;this.drawBlood(e)}},{key:"addPet",value:function(){this.pet=game.add.image(-this.player.width/2-10,-this.player.height/2-10,keyMap.pet),this.pet.anchor.set(.5,.5),this.pet.scale.set(.2,.2),this.pet.fireGroup=game.add.group(),this.pet.fireGroup.enableBody=!0;var e=game.add.tween(this.pet).to({y:this.pet.world.y-20},1e3,Phaser.Easing.Linear.In,!0);e.yoyo(!0),e.repeat(),this.player.addChild(this.pet)}},{key:"petFire",value:function(){if(!this.stopPetFire||this.pet.visible){var e=(new Date).getTime()-this.petFireTime,i=Math.PI/this.config.petFireCount;if(e>this.config.petFireCreateDis){for(var t=0;t<this.config.petFireCount;t++){var o=this.pet.fireGroup.getFirstExists(!1);o||((o=this.pet.fireGroup.create(0,0,keyMap.fireBall)).animations.add("mover",[0,1,2,3],25,!0),o.animations.play("mover"),o.scale.set(this.config.fireScale,this.config.fireScale),o.anchor.set(.5,.5),o.body.setSize(o.width-rem2px(.3),o.height),o.checkWorldBounds=!0,o.outOfBoundsKill=!0);var a=this.pet.world.x+this.pet.width/2,s=this.pet.world.y+this.pet.height/2;this.pet.world.x==Math.abs(game.camera.world.x)&&(a=this.player.world.x-this.player.width/2-10,s=this.player.world.y-this.player.height/2-10),o.reset(a,s);var n=i*t;o.body.velocity.x=Math.sin(n+this.stick.rotation)*this.config.petFireSpeed,o.body.velocity.y=Math.cos(n+this.stick.rotation-Math.PI)*this.config.petFireSpeed,o.rotation=computeRotation(0,0,o.body.velocity.x,o.body.velocity.y)+Math.PI}this.audioFire.play(),this.petFireTime=(new Date).getTime()}}}},{key:"axRotate",value:function(){var e=(new Date).getTime()-this.axTime;this.stopAx||e<this.config.axTimeDis?this.axLastTime=(new Date).getTime():(this.audioAxStop||(this.audioAx.play("",.2),this.audioAxStop=!0),this.ax.visible=!0,this.ax.body.enable=!0,(new Date).getTime()-this.axLastTime<=this.config.axContinuedTime?(this.ax.rotation+=this.config.axRotateSpeed,this.ax.x=this.player.x,this.ax.y=this.player.y):(this.ax.visible=!1,this.ax.body.enable=!1,this.audioAxStop=!1,this.axTime=(new Date).getTime()))}},{key:"fireKnife",value:function(){if(!this.stopKnife){var e=(new Date).getTime()-this.knifeCreateTime,i=Math.PI/this.config.knifeCount;if(e>this.config.knifeCreateDis){for(var t=0;t<this.config.knifeCount;t++){var o=this.KnifeGroup.getFirstExists(!1);o||((o=this.KnifeGroup.create(this.player.x,this.player.y,keyMap.knife)).scale.set(this.config.knifeScale,this.config.knifeScale),o.animations.add("rotation",[0,1,2,3,4],45,!0),o.animations.play("rotation"),o.body.setSize(o.width,o.height),o.checkWorldBounds=!0,o.outOfBoundsKill=!0,o.checkWorldBounds=!0,o.outOfBoundsKill=!0),o.reset(this.player.x,this.player.y);var a=i*t;o.body.velocity.x=Math.sin(a+this.stick.rotation)*this.config.knifeSpeed,o.body.velocity.y=Math.cos(a+this.stick.rotation-Math.PI)*this.config.knifeSpeed}this.audioKnife.play(),this.knifeCreateTime=(new Date).getTime()}}}},{key:"drawBlood",value:function(e){var i=-this.player.width/2,t=this.player.height/2+10,o=16777215;this.blood.clear(),this.blood.beginFill(65280,1),this.blood.lineStyle(0),this.blood.drawRect(i,t,e,8),this.blood.lineStyle(2,o,1),this.blood.moveTo(i,t),this.blood.lineTo(i+this.player.width,t),this.blood.lineStyle(2,o,1),this.blood.moveTo(i+this.player.width,t),this.blood.lineTo(i+this.player.width,8+t),this.blood.lineStyle(2,o,1),this.blood.moveTo(i+this.player.width,8+t),this.blood.lineTo(i,8+t),this.blood.lineStyle(2,o,1),this.blood.moveTo(i,8+t),this.blood.lineTo(i,t),this.blood.endFill()}}]),r}();