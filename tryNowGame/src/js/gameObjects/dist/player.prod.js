"use strict";function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _defineProperties(t,e){for(var i=0;i<e.length;i++){var o=e[i];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}function _createClass(t,e,i){return e&&_defineProperties(t.prototype,e),i&&_defineProperties(t,i),t}var Player=function(){function t(){_classCallCheck(this,t),this.config={moveSpeed:200,bulletDis:500,bulletSpeed:700,tornadosRotationSpeed:.04,tornadosCount:6,checkScope:100,petFireSpeed:500,petFireDis:100,petFireCount:5,petFireCreateDis:1e3,knifeCount:6,knifeCreateDis:300,knifeSpeed:500,curvature:.1},this.isDead=!1,this.maxLife=10,this.life=10,this.fireTime=(new Date).getTime(),this.petFireTime=(new Date).getTime(),this.petFireCreateTime=(new Date).getTime(),this.knifeCreateTime=(new Date).getTime(),this.isPetFire=!0,this.stopTornado=!0,this.stopKnife=!0,this.stopPetFire=!0,this.petFireCount=0,this.init()}return _createClass(t,[{key:"init",value:function(){this.initPlayer(),this.initVirtualJoystick()}},{key:"initPlayer",value:function(){this.player=game.add.sprite(game.world.centerX,game.world.centerY,keyMap.player),game.physics.arcade.enable(this.player,Phaser.Physics.ARCADE),this.player.body.setSize(this.player.width,this.player.height),this.player.scale.set(.7,.7),this.player.body.immovable=!0,this.player.body.collideWorldBounds=!0,this.addPet(),this.pet.visible=!1,this.player.anchor.set(.5,.5);var t=game.add.tween(this.player).to({height:this.player.height/1.2,width:1.2*this.player.width},200,Phaser.Easing.Sinusoidal.Out,!0);t.yoyo(!0),t.repeat(),this.animations=this.player.animations,this.animations.add("left",[0],5,!0),this.animations.add("right",[1],5,!0),this.animations.frame=4,this.bullets=game.add.group(),this.bullets.enableBody=!0,this.blood=game.add.graphics(),this.player.addChild(this.blood),this.drawBlood(this.player.width),this.KnifeGroup=game.add.group(),this.KnifeGroup.enableBody=!0,this.tornados=game.add.group(),this.tornados.enableBody=!0,this.isDead=!1}},{key:"initVirtualJoystick",value:function(){this.pad=game.plugins.add(Phaser.VirtualJoystick),this.stick=this.pad.addStick(game.world.centerX,game.world.centerY+rem2px(3),200,keyMap.joystick),this.stick.scale=scaleAdaptation(247)}},{key:"run",value:function(){this.stick.isDown?0<game.physics.arcade.velocityFromRotation(this.stick.rotation,this.stick.force*this.config.moveSpeed,this.player.body.velocity).x?(this.pet.frame=1,this.animations.play("right"),this.player.direction="right"):(this.pet.frame=0,this.animations.play("left"),this.player.direction="left"):this.stop()}},{key:"stop",value:function(){this.animations.stop(),this.player.body.velocity.set(0)}},{key:"start",value:function(){this.animations.play()}},{key:"fire",value:function(t){var e,i,o=this;this.isDead||(e=this.player.direction,(new Date).getTime()-this.fireTime>this.config.bulletDis&&((i=this.bullets.getFirstExists(!1))||((i=this.bullets.create(this.player.x,this.player.y,keyMap.gun)).scale.set(.5,.5),i.anchor.set(.5,.5),i.body.setSize(i.width,i.height)),i.reset(this.player.x,this.player.y),i.checkWorldBounds=!0,i.outOfBoundsKill=!0,i.vector=null,"right"===e?(i.direction="right",i.rotation=3.14):(i.rotation=0,i.direction="left"),t&&(i.vector=computeVector(t.position.x,t.position.y,i.position.x,i.position.y),i.rotation=computeRotation(t.position.x,t.position.y,i.position.x,i.position.y)+Math.PI),this.fireTime=(new Date).getTime()),this.bullets.length&&this.bullets.forEachAlive(function(t){t.vector?(t.body.velocity.x=t.vector.x*o.config.bulletSpeed,t.body.velocity.y=t.vector.y*o.config.bulletSpeed):"left"===t.direction?t.body.velocity.x=-o.config.bulletSpeed:t.body.velocity.x=o.config.bulletSpeed}))}},{key:"dead",value:function(){this.player.kill(),this.isDead=!0}},{key:"injury",value:function(){--this.life;var t=this.life/this.maxLife*this.player.width;this.drawBlood(t)}},{key:"addTornadoSkill",value:function(){this.stopTornado=!1,this.tornados.pivot.x=this.player.x,this.tornados.pivot.y=this.player.y;for(var t=2*Math.PI/this.config.tornadosCount,e=rem2px(2),i=0;i<this.config.tornadosCount;i++){var o=this.tornados.create(this.player.x,this.player.y,keyMap.tornado),s=this.player.x+Math.sin(t*i)*e,a=this.player.y+Math.cos(t*i)*e;o.scale.set(.3,.3),o.anchor.set(.5,.5),o.animations.add("rotation",null,25,!0),o.animations.play("rotation");game.add.tween(o).to({x:s,y:a},1e3,Phaser.Easing.Sinusoidal.Out,!0)}}},{key:"tornadosRotate",value:function(){var e=this;this.tornados&&!this.stopTornado&&(this.tornados.x=this.player.x,this.tornados.y=this.player.y,this.tornados.rotation+=this.config.tornadosRotationSpeed,this.tornados.forEachAlive(function(t){t.rotation-=e.config.tornadosRotationSpeed}))}},{key:"addPet",value:function(){this.pet=game.add.image(-this.player.width/2-10,-this.player.height/2-10,keyMap.pet),this.pet.anchor.set(.5,.5),this.pet.scale.set(.2,.2),this.pet.fireGroup=game.add.group(),this.pet.fireGroup.enableBody=!0;var t=game.add.tween(this.pet).to({y:this.pet.world.y-20},1e3,Phaser.Easing.Linear.In,!0);t.yoyo(!0),t.repeat(),this.player.addChild(this.pet)}},{key:"petFire",value:function(){var t,e,i,o;this.stopPetFire&&!this.pet.visible||(t=(new Date).getTime()-this.petFireTime,e=this.player.direction,!this.isPetFire&&(new Date).getTime()-this.petFireCreateTime>this.config.petFireCreateDis&&(this.isPetFire=!0,this.petFireCreateTime=(new Date).getTime()),this.isPetFire&&t>this.config.petFireDis&&(i=this.pet.fireGroup.getFirstExists(!1),o=(2*Math.PI/this.config.petFireCount*this.petFireCount).toFixed(2),i||((i=this.pet.fireGroup.create(0,0,keyMap.fireBall)).animations.add("mover",[0,1,2,3,4],25,!0),i.animations.play("mover"),i.scale.set(.3,.3),i.anchor.set(.5,.5),i.body.setSize(i.width,i.height)),i.reset(this.pet.world.x+this.pet.width/2,this.pet.world.y+this.pet.height/2),i.anchor.set(.5,.5),i.vector={angle:o,x:+Math.sin(o),y:+Math.cos(o)},this.petFireTime=(new Date).getTime(),i.rotation=0==o?Math.PI/2:2*Math.PI/this.config.petFireCount*(1-this.petFireCount),i.body.velocity.x=i.vector.x*this.config.petFireSpeed,i.body.velocity.y=i.vector.y*this.config.petFireSpeed,i.checkWorldBounds=!0,i.outOfBoundsKill=!0,i.direction="right"===e?"right":"left",this.petFireCount+=1,this.petFireCount>=this.config.petFireCount&&(this.isPetFire=!1,this.petFireCount=0)))}},{key:"fireKnife",value:function(){if(!this.stopKnife){var t=(new Date).getTime()-this.knifeCreateTime,e=Math.PI/this.config.knifeCount;if(t>this.config.knifeCreateDis){for(var i=0;i<this.config.knifeCount;i++){var o=this.KnifeGroup.getFirstExists(!1);o||((o=this.KnifeGroup.create(this.player.x,this.player.y,keyMap.knife)).scale.set(.2,.2),o.animations.add("rotation",[0,1,2,3,4],45,!0),o.animations.play("rotation"),o.body.setSize(o.width,o.height),o.checkWorldBounds=!0,o.outOfBoundsKill=!0,o.checkWorldBounds=!0,o.outOfBoundsKill=!0),o.reset(this.player.x,this.player.y);var s=e*i;o.body.velocity.x=Math.sin(s+this.stick.rotation)*this.config.knifeSpeed,o.body.velocity.y=Math.cos(s+this.stick.rotation-Math.PI)*this.config.knifeSpeed}this.knifeCreateTime=(new Date).getTime()}}}},{key:"drawBlood",value:function(t){var e=-this.player.width/2,i=this.player.height/2+10,o=16777215;this.blood.clear(),this.blood.beginFill(65280,1),this.blood.lineStyle(0),this.blood.drawRect(e,i,t,8),this.blood.lineStyle(2,o,1),this.blood.moveTo(e,i),this.blood.lineTo(e+this.player.width,i),this.blood.lineStyle(2,o,1),this.blood.moveTo(e+this.player.width,i),this.blood.lineTo(e+this.player.width,8+i),this.blood.lineStyle(2,o,1),this.blood.moveTo(e+this.player.width,8+i),this.blood.lineTo(e,8+i),this.blood.lineStyle(2,o,1),this.blood.moveTo(e,8+i),this.blood.lineTo(e,i),this.blood.endFill()}}]),t}();