"use strict";function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _defineProperties(t,e){for(var i=0;i<e.length;i++){var o=e[i];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}function _createClass(t,e,i){return e&&_defineProperties(t.prototype,e),i&&_defineProperties(t,i),t}var Player=function(){function t(){_classCallCheck(this,t),this.config={moveSpeed:200,bulletDis:1e3,bulletSpeed:700,tornadosRotationSpeed:.05,tornadosCount:6,checkScope:100,petFireSpeed:500,petFireDis:100,petFireCount:5,petFireCreateDis:1e3,curvature:.1},this.isDead=!1,this.maxLife=10,this.life=10,this.fireTime=(new Date).getTime(),this.petFireTime=(new Date).getTime(),this.petFireCreateTime=(new Date).getTime(),this.isPetFire=!0,this.petFireCount=0,this.init()}return _createClass(t,[{key:"init",value:function(){this.initPlayer(),this.initVirtualJoystick()}},{key:"initPlayer",value:function(){this.player=game.add.sprite(game.world.centerX,game.world.centerY,keyMap.player),game.physics.arcade.enable(this.player,Phaser.Physics.ARCADE),this.player.body.setSize(this.player.width,this.player.height),this.player.scale.set(.7,.7),this.player.body.immovable=!0,this.player.body.collideWorldBounds=!0,this.player.anchor.set(.5,.5);var t=game.add.tween(this.player).to({height:this.player.height/1.2,width:1.2*this.player.width},500,Phaser.Easing.Sinusoidal.Out,!0);t.yoyo(!0),t.repeat(),this.animations=this.player.animations,this.animations.add("left",[0],5,!0),this.animations.add("right",[1],5,!0),this.animations.frame=4,this.bullets=game.add.group(),this.bullets.enableBody=!0,this.blood=game.add.graphics(),this.player.addChild(this.blood),this.drawBlood(this.player.width),this.isDead=!1}},{key:"initVirtualJoystick",value:function(){this.pad=game.plugins.add(Phaser.VirtualJoystick),this.stick=this.pad.addStick(game.world.centerX,game.world.centerY+250,200,keyMap.joystick),this.stick.scale=scaleAdaptation(247)}},{key:"run",value:function(){this.stick.isDown?0<game.physics.arcade.velocityFromRotation(this.stick.rotation,this.stick.force*this.config.moveSpeed,this.player.body.velocity).x?(this.pet.frame=1,this.animations.play("right"),this.player.direction="right"):(this.pet.frame=0,this.animations.play("left"),this.player.direction="left"):this.stop()}},{key:"stop",value:function(){this.animations.stop(),this.player.body.velocity.set(0)}},{key:"fire",value:function(t){var e,i,o=this;this.isDead||(e=this.player.direction,(new Date).getTime()-this.fireTime>this.config.bulletDis&&((i=this.bullets.getFirstExists(!1))||((i=this.bullets.create(this.player.x,this.player.y,keyMap.gun)).scale.set(.5,.5),i.anchor.set(.5,.5),i.body.setSize(i.width,i.height)),i.reset(this.player.x,this.player.y),i.checkWorldBounds=!0,i.outOfBoundsKill=!0,"right"===e?(i.direction="right",i.rotation=3.14):(i.rotation=0,i.direction="left"),t&&(i.vector=computeVector(t.position.x,t.position.y,i.position.x,i.position.y),i.rotation=computeRotation(t.position.x,t.position.y,i.position.x,i.position.y)+Math.PI),this.fireTime=(new Date).getTime()),this.bullets.length&&this.bullets.forEachAlive(function(t){t.vector?(t.body.velocity.x=t.vector.x*o.config.bulletSpeed,t.body.velocity.y=t.vector.y*o.config.bulletSpeed):"left"===t.direction?t.body.velocity.x=-o.config.bulletSpeed:t.body.velocity.x=o.config.bulletSpeed}))}},{key:"dead",value:function(){this.player.kill(),this.isDead=!0}},{key:"injury",value:function(){--this.life;var t=this.life/this.maxLife*this.player.width;this.drawBlood(t)}},{key:"addTornadoSkill",value:function(){this.tornados=game.add.group(),this.tornados.enableBody=!0,this.tornados.pivot.x=this.player.x,this.tornados.pivot.y=this.player.y;for(var t=2*Math.PI/this.config.tornadosCount,e=0;e<this.config.tornadosCount;e++){var i=game.add.spine(this.player.x,this.player.y,keyMap.tornado);this.tornados.add(i),i.setAnimationByName(0,keyMap.tornadoRotation,!0),i.scale.set(.3,.3),i.body=null,game.physics.enable(i,Phaser.Physics.ARCADE),console.log(i);var o=this.player.x+200*Math.sin(t*e),s=this.player.y+200*Math.cos(t*e);game.add.tween(i).to({x:o,y:s},1e3,Phaser.Easing.Sinusoidal.Out,!0)}}},{key:"addPet",value:function(){this.pet=game.add.image(-this.player.width/2-10,-this.player.height/2-10,keyMap.pet),this.pet.anchor.set(.5,.5),this.pet.scale.set(.2,.2),this.pet.fireGroup=game.add.group(),this.pet.fireGroup.enableBody=!0;var t=game.add.tween(this.pet).to({y:this.pet.world.y-20},1e3,Phaser.Easing.Linear.In,!0);t.yoyo(!0),t.repeat(),this.player.addChild(this.pet)}},{key:"petFire",value:function(){var t,e,i=(new Date).getTime()-this.petFireTime,o=this.player.direction;!this.isPetFire&&(new Date).getTime()-this.petFireCreateTime>this.config.petFireCreateDis&&(this.isPetFire=!0,this.petFireCreateTime=(new Date).getTime()),this.isPetFire&&i>this.config.petFireDis&&(t=this.pet.fireGroup.getFirstExists(!1),e=(2*Math.PI/this.config.petFireCount*this.petFireCount).toFixed(2),t||((t=this.pet.fireGroup.create(0,0,keyMap.fireBall)).animations.add("mover",[0,1,2,3,4],10,!0),t.animations.play("mover"),t.scale.set(.5,.5),t.anchor.set(.5,.5),t.body.setSize(t.width,t.height)),t.anchor.set(.5,.5),t.vector={angle:e,x:+Math.sin(e),y:+Math.cos(e)},t.reset(this.pet.world.x+this.pet.width/2,this.pet.world.y+this.pet.height/2),this.petFireTime=(new Date).getTime(),t.rotation=0==e?Math.PI/2:2*Math.PI/this.config.petFireCount*(1-this.petFireCount),t.body.velocity.x=t.vector.x*this.config.petFireSpeed,t.body.velocity.y=t.vector.y*this.config.petFireSpeed,t.checkWorldBounds=!0,t.outOfBoundsKill=!0,t.direction="right"===o?"right":"left",this.petFireCount+=1,this.petFireCount>=this.config.petFireCount&&(this.isPetFire=!1,this.petFireCount=0))}},{key:"tornadosRotate",value:function(){var e=this;this.tornados.stop||(this.tornados.x=this.player.x,this.tornados.y=this.player.y,this.tornados.rotation+=this.config.tornadosRotationSpeed,this.tornados.forEachAlive(function(t){t.rotation-=e.config.tornadosRotationSpeed}))}},{key:"stopTornadosRotate",value:function(){this.tornados.stop=!0}},{key:"drawBlood",value:function(t){var e=-this.player.width/2,i=this.player.height/2+10,o=16777215;this.blood.clear(),this.blood.beginFill(65280,1),this.blood.lineStyle(0),this.blood.drawRect(e,i,t,8),this.blood.lineStyle(2,o,1),this.blood.moveTo(e,i),this.blood.lineTo(e+this.player.width,i),this.blood.lineStyle(2,o,1),this.blood.moveTo(e+this.player.width,i),this.blood.lineTo(e+this.player.width,8+i),this.blood.lineStyle(2,o,1),this.blood.moveTo(e+this.player.width,8+i),this.blood.lineTo(e,8+i),this.blood.lineStyle(2,o,1),this.blood.moveTo(e,8+i),this.blood.lineTo(e,i),this.blood.endFill()}}]),t}();